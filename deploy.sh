# –ö–û–ú–ê–ù–î–ê –ó–ê–ü–£–°–ö–ê –í–°–ï–• –ö–û–ú–ü–û–ù–ï–ù–¢–û–í –ü–†–û–ï–ö–¢–ê
# ./deploy.sh

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –±—ç–∫–µ–Ω–¥–∞
export DJANGO_SETTINGS_MODULE=backend.config.settings

# # –∑–∞–ø—É—Å–∫ (venv)
# # –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ venv, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ –∏–∑–º–µ–Ω–∏—Ç–µ –ø—É—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
# # source venv/bin/activate
# # echo " –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ."

# --- 1. –ó–ê–ü–£–°–ö DAPHNE (ASGI/Channels) –Ω–∞ 8001 ---
echo " –ó–∞–ø—É—Å–∫–∞–µ–º Daphne (Channels) –Ω–∞ –ø–æ—Ä—Ç—É 8001..."
python manage.py runserver 8001 &
DAPHNE_PID=$!

# --- 2. –ó–ê–ü–£–°–ö RUNSERVER (REST API) –Ω–∞ 8000 ---
echo " –ó–∞–ø—É—Å–∫–∞–µ–º Django Runserver (REST API) –Ω–∞ –ø–æ—Ä—Ç—É 8000..."
python manage.py runserver 8000 &
RUNSERVER_PID=$!

# --- 3. –ó–ê–ü–£–°–ö –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê –ö–û–ú–ê–ù–î–´ float_expired_posts (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É) ---
# –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –≤ —Ü–∏–∫–ª–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –≤ 60 —Å–µ–∫—É–Ω–¥.
echo " –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–æ–º–∞–Ω–¥—ã float_expired_posts (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)..."

# –ò–º—è –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ float_expired_posts.py
COMMAND_NAME="float_expired_posts" 
# –õ–æ–≥–∏—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª
LOG_FILE="./float_expired_posts.log" 

# –¶–∏–∫–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–º–∞–Ω–¥—ã –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
(
    while true; do
        echo "($(date '+%Y-%m-%d %H:%M:%S')) –ó–∞–ø—É—Å–∫ –∫–æ–º–∞–Ω–¥—ã $COMMAND_NAME..." >> "$LOG_FILE"
        python manage.py "$COMMAND_NAME" >> "$LOG_FILE" 2>&1
        echo "($(date '+%Y-%m-%d %H:%M:%S')) –ö–æ–º–∞–Ω–¥–∞ $COMMAND_NAME –∑–∞–≤–µ—Ä—à–µ–Ω–∞." >> "$LOG_FILE"
        # –ü–∞—É–∑–∞ 60 —Å–µ–∫—É–Ω–¥
        sleep 60
    done
) &
SCHEDULER_PID=$!
echo " –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ (PID: $SCHEDULER_PID). –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ $LOG_FILE"

# --- 4. –ó–ê–ü–£–°–ö –§–†–û–ù–¢–ï–ù–î–ê (npm start) ---
echo " –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (npm start)..."
# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É frontend –∏ –∑–∞–ø—É—Å–∫–∞–µ–º npm start
(cd frontend && npm start) & 
FRONTEND_PID=$!
# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: 'npm start' –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª, –Ω–æ –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
# —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –º–æ–≥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.

echo ""
echo " –í–°–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ –ó–ê–ü–£–©–ï–ù–´:"
echo " ¬† - REST API: ¬† http://127.0.0.1:8000/ (PID: $RUNSERVER_PID)"
echo " ¬† - CHANNELS: ¬† http://127.0.0.1:8001/ (PID: $DAPHNE_PID)"
echo " ¬† - SCHEDULER: ¬† float_expired_posts (PID: $SCHEDULER_PID, log: $LOG_FILE)"
echo " ¬† - FRONTEND: ¬† (3000, PID: $FRONTEND_PID)"
echo ""
echo "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –≤—ã—Ö–æ–¥–∞..."

# –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
read

# --- 5. –û–°–¢–ê–ù–û–í–ö–ê –í–°–ï–• –ü–†–û–¶–ï–°–°–û–í ---
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä—ã –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥..."

kill $DAPHNE_PID 2>/dev/null
kill $RUNSERVER_PID 2>/dev/null
kill $SCHEDULER_PID 2>/dev/null
kill $FRONTEND_PID 2>/dev/null

echo "–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –í—ã—Ö–æ–¥."